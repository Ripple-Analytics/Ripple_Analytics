# Mental Models System - Erlang/OTP Microservices Architecture
# 
# Start all services: docker-compose up -d
# View logs: docker-compose logs -f
# Stop all services: docker-compose down
# 
# BULLETPROOF AUTO-UPDATE SYSTEM:
# Multiple independent update sources with automatic fallback:
#   1. GitHub Source (SSH → PAT → Public HTTPS)
#   2. Google Drive Source (backup sync)
#   3. Local Cache (last known good versions)
# 
# Chaos Monkey tests resilience by simulating failures.
# 
# Access the UI at: http://localhost:3000
# Access the Settings page for one-click updates and chaos testing

services:
  # ============================================================================
  # UPDATE ORCHESTRATOR - Coordinates all update sources
  # ============================================================================
  # ============================================================================
  # AUTO-UPDATER SERVICE - BULLETPROOF CONFIGURATION
  # This service MUST NEVER STOP - it is the core of the auto-update system
  # ============================================================================
  auto-updater-service:
    build: ./auto_updater_service
    container_name: mental-models-auto-updater
    ports:
      - "8006:8006"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - updater-repo:/repo
      - updater-data:/data
      - .:/services:ro
      - ${SSH_KEY_PATH:-./ssh_deploy_key}:/root/.ssh/deploy_key:ro
    environment:
      - GITHUB_SSH_URL=git@github.com:Ripple-Analytics/Ripple_Analytics.git
      - GITHUB_REPO_URL=https://github.com/Ripple-Analytics/Ripple_Analytics.git
      - GITHUB_BRANCH=release
      - UPDATE_CHECK_INTERVAL=300
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - GITHUB_REPO=Ripple-Analytics/Ripple_Analytics
      - GDRIVE_BACKUP_URL=${GDRIVE_BACKUP_URL:-}
      # Internal source service URLs
      - GITHUB_SOURCE_URL=http://github-source:8010
      - GDRIVE_SOURCE_URL=http://gdrive-source:8011
      - LOCAL_CACHE_URL=http://local-cache:8012
    depends_on:
      - github-source
      - gdrive-source
      - local-cache
    # CRITICAL: Use 'always' instead of 'unless-stopped' to ensure auto-updater
    # restarts even after manual stops or system reboots
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8006/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - mental-models-network

  # ============================================================================
  # UPDATE SOURCE SERVICES - Independent backup sources
  # ============================================================================
  
  # GitHub Source - Primary update source with multi-auth fallback
  github-source:
    build: ./github_source_service
    container_name: mental-models-github-source
    ports:
      - "8010:8010"
    volumes:
      - github-repo:/repo/github
      - ${SSH_KEY_PATH:-./ssh_deploy_key}:/root/.ssh/deploy_key:ro
    environment:
      - GITHUB_SSH_URL=git@github.com:Ripple-Analytics/Ripple_Analytics.git
      - GITHUB_REPO_URL=https://github.com/Ripple-Analytics/Ripple_Analytics.git
      - GITHUB_BRANCH=release
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - GITHUB_REPO=Ripple-Analytics/Ripple_Analytics
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8010/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - mental-models-network

  # Google Drive Source - Backup update source
  gdrive-source:
    build: ./gdrive_source_service
    container_name: mental-models-gdrive-source
    ports:
      - "8011:8011"
    volumes:
      - gdrive-repo:/repo/gdrive
      - ${RCLONE_CONFIG:-./rclone.conf}:/root/.config/rclone/rclone.conf:ro
    environment:
      - GDRIVE_BACKUP_URL=${GDRIVE_BACKUP_URL:-}
      - GDRIVE_RCLONE_REMOTE=${GDRIVE_RCLONE_REMOTE:-}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8011/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - mental-models-network

  # Local Cache - Stores last known good versions for rollback
  local-cache:
    build: ./local_cache_service
    container_name: mental-models-local-cache
    ports:
      - "8012:8012"
    volumes:
      - local-cache-data:/cache
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8012/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - mental-models-network

  # ============================================================================
  # CHAOS MONKEY - Resilience Testing
  # ============================================================================
  update-chaos-monkey:
    build: ./update_chaos_monkey
    container_name: mental-models-update-chaos
    ports:
      - "8013:8013"
    environment:
      - AUTO_UPDATER_URL=http://auto-updater-service:8006
      - GITHUB_SOURCE_URL=http://github-source:8010
      - GDRIVE_SOURCE_URL=http://gdrive-source:8011
      - LOCAL_CACHE_URL=http://local-cache:8012
    depends_on:
      - auto-updater-service
      - github-source
      - gdrive-source
      - local-cache
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8013/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - mental-models-network

  # ============================================================================
  # WATCHTOWER - Container Auto-Update
  # ============================================================================
  watchtower:
    image: containrrr/watchtower
    container_name: mental-models-watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=300
      - WATCHTOWER_INCLUDE_RESTARTING=true
    restart: unless-stopped
    networks:
      - mental-models-network

  # ============================================================================
  # CORE SERVICES
  # ============================================================================
  
  api-gateway:
    build: ./api_gateway
    container_name: mental-models-api-gateway
    ports:
      - "8000:8000"
    environment:
      - ANALYSIS_SERVICE_URL=http://analysis-service:8001
      - HARVESTER_SERVICE_URL=http://harvester-service:8002
      - STORAGE_SERVICE_URL=http://storage-service:8003
    depends_on:
      - analysis-service
      - harvester-service
      - storage-service
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - mental-models-network

  analysis-service:
    build: ./analysis_service
    container_name: mental-models-analysis
    ports:
      - "8001:8001"
    environment:
      - LM_STUDIO_URL=http://host.docker.internal:1234
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - mental-models-network

  harvester-service:
    build: ./harvester_service
    container_name: mental-models-harvester
    ports:
      - "8002:8002"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - mental-models-network

  storage-service:
    build: ./storage_service
    container_name: mental-models-storage
    ports:
      - "8003:8003"
    volumes:
      - storage-data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - mental-models-network

  chaos-engineering:
    build: ./chaos_engineering
    container_name: mental-models-chaos
    ports:
      - "8005:8005"
    environment:
      - API_GATEWAY_URL=http://api-gateway:8000
      - ANALYSIS_SERVICE_URL=http://analysis-service:8001
      - HARVESTER_SERVICE_URL=http://harvester-service:8002
      - STORAGE_SERVICE_URL=http://storage-service:8003
    depends_on:
      - api-gateway
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8005/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - mental-models-network

  # ============================================================================
  # BLUE-GREEN ORCHESTRATOR - Centralized Deployment Management
  # Self-managing blue/green deployment with automatic failover
  # ============================================================================
  
  # Blue-Green Orchestrator - BLUE Environment
  blue-green-orchestrator-blue:
    build: ./blue_green_orchestrator
    container_name: mental-models-orchestrator-blue
    volumes:
      - orchestrator-data:/data
    environment:
      - DEPLOYMENT_ENV=blue
      - NGINX_RELOAD_URL=http://nginx-proxy:8080/reload
      - LISTEN_PORT=8020
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8020/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - mental-models-network

  # Blue-Green Orchestrator - GREEN Environment
  blue-green-orchestrator-green:
    build: ./blue_green_orchestrator
    container_name: mental-models-orchestrator-green
    volumes:
      - orchestrator-data:/data
    environment:
      - DEPLOYMENT_ENV=green
      - NGINX_RELOAD_URL=http://nginx-proxy:8080/reload
      - LISTEN_PORT=8020
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8020/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - mental-models-network

  # Blue-Green Orchestrator Proxy - Routes to active orchestrator
  blue-green-orchestrator:
    build: ./nginx_proxy
    container_name: mental-models-orchestrator-proxy
    ports:
      - "8020:8020"
    volumes:
      - orchestrator-config:/etc/nginx/conf.d
    environment:
      - UPSTREAM_BLUE=blue-green-orchestrator-blue:8020
      - UPSTREAM_GREEN=blue-green-orchestrator-green:8020
      - ACTIVE_ENV=${ORCHESTRATOR_ACTIVE:-blue}
      - LISTEN_PORT=8020
    depends_on:
      - blue-green-orchestrator-blue
      - blue-green-orchestrator-green
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8020/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - mental-models-network

  # ============================================================================
  # BLUE-GREEN DEPLOYMENT - Zero Downtime Updates
  # ============================================================================
  
  # Nginx Proxy - Routes traffic to active environment (blue or green)
  nginx-proxy:
    build: ./nginx_proxy
    container_name: mental-models-proxy
    ports:
      - "3000:3000"
      - "8080:8080"
    volumes:
      - nginx-config:/etc/nginx/conf.d
    depends_on:
      - desktop-ui-blue
      - desktop-ui-green
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - mental-models-network

  # Desktop UI - BLUE Environment
  desktop-ui-blue:
    build: ./desktop_ui
    container_name: mental-models-ui-blue
    environment:
      - API_GATEWAY_URL=http://api-gateway:8000
      - AUTO_UPDATER_URL=http://auto-updater-service:8006
      - GITHUB_SOURCE_URL=http://github-source:8010
      - GDRIVE_SOURCE_URL=http://gdrive-source:8011
      - LOCAL_CACHE_URL=http://local-cache:8012
      - CHAOS_MONKEY_URL=http://update-chaos-monkey:8013
      - MACHINE_GUID=${MACHINE_GUID:-}
      - HOST_PATH=${HOST_PATH:-}
      - DEPLOYMENT_ENV=blue
    depends_on:
      - api-gateway
      - chaos-engineering
      - auto-updater-service
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      - mental-models-network

  # Desktop UI - GREEN Environment
  desktop-ui-green:
    build: ./desktop_ui
    container_name: mental-models-ui-green
    environment:
      - API_GATEWAY_URL=http://api-gateway:8000
      - AUTO_UPDATER_URL=http://auto-updater-service:8006
      - GITHUB_SOURCE_URL=http://github-source:8010
      - GDRIVE_SOURCE_URL=http://gdrive-source:8011
      - LOCAL_CACHE_URL=http://local-cache:8012
      - CHAOS_MONKEY_URL=http://update-chaos-monkey:8013
      - MACHINE_GUID=${MACHINE_GUID:-}
      - HOST_PATH=${HOST_PATH:-}
      - DEPLOYMENT_ENV=green
    depends_on:
      - api-gateway
      - chaos-engineering
      - auto-updater-service
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      - mental-models-network

networks:
  mental-models-network:
    driver: bridge

volumes:
  storage-data:
    driver: local
  updater-repo:
    driver: local
  updater-data:
    driver: local
  github-repo:
    driver: local
  gdrive-repo:
    driver: local
  local-cache-data:
    driver: local
  nginx-config:
    driver: local
  orchestrator-data:
    driver: local
  orchestrator-config:
    driver: local
