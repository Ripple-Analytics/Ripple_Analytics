# Blue-Green Deployment Nginx Proxy
# Routes traffic to either blue or green environment based on health checks
# Ensures zero downtime during updates for ALL core services

worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    keepalive_timeout 65;

    # Desktop UI upstreams
    upstream ui-blue {
        server desktop-ui-blue:3000 max_fails=3 fail_timeout=30s;
    }
    upstream ui-green {
        server desktop-ui-green:3000 max_fails=3 fail_timeout=30s;
    }

    # API Gateway upstreams
    upstream api-blue {
        server api-gateway-blue:8000 max_fails=3 fail_timeout=30s;
    }
    upstream api-green {
        server api-gateway-green:8000 max_fails=3 fail_timeout=30s;
    }

    # Analysis Service upstreams
    upstream analysis-blue {
        server analysis-service-blue:8001 max_fails=3 fail_timeout=30s;
    }
    upstream analysis-green {
        server analysis-service-green:8001 max_fails=3 fail_timeout=30s;
    }

    # Harvester Service upstreams
    upstream harvester-blue {
        server harvester-service-blue:8002 max_fails=3 fail_timeout=30s;
    }
    upstream harvester-green {
        server harvester-service-green:8002 max_fails=3 fail_timeout=30s;
    }

    # Storage Service upstreams
    upstream storage-blue {
        server storage-service-blue:8003 max_fails=3 fail_timeout=30s;
    }
    upstream storage-green {
        server storage-service-green:8003 max_fails=3 fail_timeout=30s;
    }

    # Health check and management endpoints
    server {
        listen 8080;
        
        location /health {
            return 200 'OK';
            add_header Content-Type text/plain;
        }
        
        # UI health checks
        location /ui/blue/health {
            proxy_pass http://ui-blue/health;
            proxy_connect_timeout 5s;
            proxy_read_timeout 5s;
        }
        location /ui/green/health {
            proxy_pass http://ui-green/health;
            proxy_connect_timeout 5s;
            proxy_read_timeout 5s;
        }
        
        # API Gateway health checks
        location /api/blue/health {
            proxy_pass http://api-blue/health;
            proxy_connect_timeout 5s;
            proxy_read_timeout 5s;
        }
        location /api/green/health {
            proxy_pass http://api-green/health;
            proxy_connect_timeout 5s;
            proxy_read_timeout 5s;
        }
        
        # Analysis Service health checks
        location /analysis/blue/health {
            proxy_pass http://analysis-blue/health;
            proxy_connect_timeout 5s;
            proxy_read_timeout 5s;
        }
        location /analysis/green/health {
            proxy_pass http://analysis-green/health;
            proxy_connect_timeout 5s;
            proxy_read_timeout 5s;
        }
        
        # Harvester Service health checks
        location /harvester/blue/health {
            proxy_pass http://harvester-blue/health;
            proxy_connect_timeout 5s;
            proxy_read_timeout 5s;
        }
        location /harvester/green/health {
            proxy_pass http://harvester-green/health;
            proxy_connect_timeout 5s;
            proxy_read_timeout 5s;
        }
        
        # Storage Service health checks
        location /storage/blue/health {
            proxy_pass http://storage-blue/health;
            proxy_connect_timeout 5s;
            proxy_read_timeout 5s;
        }
        location /storage/green/health {
            proxy_pass http://storage-green/health;
            proxy_connect_timeout 5s;
            proxy_read_timeout 5s;
        }
        
        # Active environment endpoint
        location /active {
            default_type text/plain;
            alias /etc/nginx/active_env;
        }
    }

    # Desktop UI - Port 3000
    server {
        listen 3000;
        include /etc/nginx/conf.d/active.conf;
        
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # API Gateway - Port 8000
    server {
        listen 8000;
        include /etc/nginx/conf.d/active_api.conf;
        
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Analysis Service - Port 8001
    server {
        listen 8001;
        include /etc/nginx/conf.d/active_analysis.conf;
        
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Harvester Service - Port 8002
    server {
        listen 8002;
        include /etc/nginx/conf.d/active_harvester.conf;
        
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Storage Service - Port 8003
    server {
        listen 8003;
        include /etc/nginx/conf.d/active_storage.conf;
        
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
