# Blue-Green Deployment Nginx Proxy
# Routes traffic to either blue or green environment based on health checks
# Ensures zero downtime during updates for ALL core services

worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    keepalive_timeout 65;

    # ============================================================================
    # DESKTOP UI UPSTREAMS
    # ============================================================================
    upstream ui-blue {
        server desktop-ui-blue:3000 max_fails=3 fail_timeout=30s;
    }
    upstream ui-green {
        server desktop-ui-green:3000 max_fails=3 fail_timeout=30s;
    }

    # ============================================================================
    # API GATEWAY UPSTREAMS
    # ============================================================================
    upstream api-gateway-blue {
        server api-gateway-blue:8000 max_fails=3 fail_timeout=30s;
    }
    upstream api-gateway-green {
        server api-gateway-green:8000 max_fails=3 fail_timeout=30s;
    }

    # ============================================================================
    # ANALYSIS SERVICE UPSTREAMS
    # ============================================================================
    upstream analysis-blue {
        server analysis-service-blue:8001 max_fails=3 fail_timeout=30s;
    }
    upstream analysis-green {
        server analysis-service-green:8001 max_fails=3 fail_timeout=30s;
    }

    # ============================================================================
    # HARVESTER SERVICE UPSTREAMS
    # ============================================================================
    upstream harvester-blue {
        server harvester-service-blue:8002 max_fails=3 fail_timeout=30s;
    }
    upstream harvester-green {
        server harvester-service-green:8002 max_fails=3 fail_timeout=30s;
    }

    # ============================================================================
    # STORAGE SERVICE UPSTREAMS
    # ============================================================================
    upstream storage-blue {
        server storage-service-blue:8003 max_fails=3 fail_timeout=30s;
    }
    upstream storage-green {
        server storage-service-green:8003 max_fails=3 fail_timeout=30s;
    }

    # ============================================================================
    # CHAOS ENGINEERING UPSTREAMS
    # ============================================================================
    upstream chaos-blue {
        server chaos-engineering-blue:8005 max_fails=3 fail_timeout=30s;
    }
    upstream chaos-green {
        server chaos-engineering-green:8005 max_fails=3 fail_timeout=30s;
    }

    # Health check endpoints
    server {
        listen 8080;
        
        location /health {
            return 200 'OK';
            add_header Content-Type text/plain;
        }
        
        # UI health checks
        location /ui/blue/health {
            proxy_pass http://ui-blue/health;
            proxy_connect_timeout 5s;
            proxy_read_timeout 5s;
        }
        location /ui/green/health {
            proxy_pass http://ui-green/health;
            proxy_connect_timeout 5s;
            proxy_read_timeout 5s;
        }
        
        # API Gateway health checks
        location /api-gateway/blue/health {
            proxy_pass http://api-gateway-blue/health;
            proxy_connect_timeout 5s;
            proxy_read_timeout 5s;
        }
        location /api-gateway/green/health {
            proxy_pass http://api-gateway-green/health;
            proxy_connect_timeout 5s;
            proxy_read_timeout 5s;
        }
        
        # Analysis service health checks
        location /analysis/blue/health {
            proxy_pass http://analysis-blue/health;
            proxy_connect_timeout 5s;
            proxy_read_timeout 5s;
        }
        location /analysis/green/health {
            proxy_pass http://analysis-green/health;
            proxy_connect_timeout 5s;
            proxy_read_timeout 5s;
        }
        
        # Harvester service health checks
        location /harvester/blue/health {
            proxy_pass http://harvester-blue/health;
            proxy_connect_timeout 5s;
            proxy_read_timeout 5s;
        }
        location /harvester/green/health {
            proxy_pass http://harvester-green/health;
            proxy_connect_timeout 5s;
            proxy_read_timeout 5s;
        }
        
        # Storage service health checks
        location /storage/blue/health {
            proxy_pass http://storage-blue/health;
            proxy_connect_timeout 5s;
            proxy_read_timeout 5s;
        }
        location /storage/green/health {
            proxy_pass http://storage-green/health;
            proxy_connect_timeout 5s;
            proxy_read_timeout 5s;
        }
        
        # Chaos engineering health checks
        location /chaos/blue/health {
            proxy_pass http://chaos-blue/health;
            proxy_connect_timeout 5s;
            proxy_read_timeout 5s;
        }
        location /chaos/green/health {
            proxy_pass http://chaos-green/health;
            proxy_connect_timeout 5s;
            proxy_read_timeout 5s;
        }
        
        # Switch endpoint - reads from file to determine active environment
        location /active {
            default_type text/plain;
            alias /etc/nginx/active_env;
        }
    }

    # ============================================================================
    # DESKTOP UI SERVER - Port 3000
    # ============================================================================
    server {
        listen 3000;
        
        # Include the active environment configuration for UI
        include /etc/nginx/conf.d/active.conf;
        
        # Proxy settings
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ============================================================================
    # API GATEWAY SERVER - Port 8000
    # ============================================================================
    server {
        listen 8000;
        
        # Include the active environment configuration for API Gateway
        include /etc/nginx/conf.d/active-api-gateway.conf;
        
        # Proxy settings
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ============================================================================
    # ANALYSIS SERVICE SERVER - Port 8001
    # ============================================================================
    server {
        listen 8001;
        
        # Include the active environment configuration for Analysis Service
        include /etc/nginx/conf.d/active-analysis.conf;
        
        # Proxy settings
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ============================================================================
    # HARVESTER SERVICE SERVER - Port 8002
    # ============================================================================
    server {
        listen 8002;
        
        # Include the active environment configuration for Harvester Service
        include /etc/nginx/conf.d/active-harvester.conf;
        
        # Proxy settings
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ============================================================================
    # STORAGE SERVICE SERVER - Port 8003
    # ============================================================================
    server {
        listen 8003;
        
        # Include the active environment configuration for Storage Service
        include /etc/nginx/conf.d/active-storage.conf;
        
        # Proxy settings
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ============================================================================
    # CHAOS ENGINEERING SERVER - Port 8005
    # ============================================================================
    server {
        listen 8005;
        
        # Include the active environment configuration for Chaos Engineering
        include /etc/nginx/conf.d/active-chaos.conf;
        
        # Proxy settings
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
